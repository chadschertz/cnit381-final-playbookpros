---
- name: Configure loopback interfaces and complete EIGRP configuration
  hosts: routers 
  gather_facts: no
  connection: network_cli
  tasks:
    # -- Configure three loopback interfaces for each router --
    - name: Set fact for loopback second octet based on hostname
      set_fact:
        loopback_second_octet: "{{ groups['routers'].index(inventory_hostname) + 1 }}"

    - name: Set loopback interface 1
      ios_config:
        lines:
          - ip address 10.{{ loopback_second_octet }}.1.1 255.255.255.255
        parents: interface Loopback1
      register: config_result_loopback1
    - name: Debug config result
      debug:
        var: config_result_loopback1

    - name: Set loopback interface 2
      ios_config:
        lines:
          - ip address 10.{{ loopback_second_octet }}.2.1 255.255.255.255
        parents: interface Loopback2
      register: config_result_loopback2
    - name: Debug config result
      debug:
        var: config_result_loopback2

    - name: Set loopback interface 3
      ios_config:
        lines:
          - ip address 10.{{ loopback_second_octet }}.3.1 255.255.255.255
        parents: interface Loopback3
      register: config_result_loopback3
    - name: Debug config result
      debug:
        var: config_result_loopback3

    - name: Verify loopback interface configuration
      ios_command:
        commands:
          - show ip interface brief
      register: output
    - name: Debug output
      debug:
        var: output.stdout_lines

    # -- Configure EIGRP AS 100 and advertise all networks --
    - name: Configure EIGRP
      ios_config:
        lines:
          - network 10.0.0.0 0.255.255.255
          - no auto-summary
        parents: router eigrp 100
      register: config_result
    - name: Debug config result
      debug:
        var: config_result

    - name: Verify EIGRP neighbors
      ios_command:
        commands:
          - show ip eigrp neighbors
      register: eigrp_neighbors
    - name: Debug EIGRP neighbors output
      debug:
        var: eigrp_neighbors.stdout_lines
    
    - name: Verify EIGRP routes
      ios_command:
        commands:
          - show ip route eigrp
      register: eigrp_routes
    - name: Debug EIGRP routes output
      debug:
        var: eigrp_routes.stdout_lines